<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Trucking Dispatch Simulator — 48 States x Top 3 Cities</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<style>
  html, body { height: 100%; margin: 0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:#0e0f10; color:#e9eef1;}
  #app { display: grid; grid-template-rows: 1fr auto; height: 100%; }
  #map { width: 100%; height: 100%; }
  .toolbar{display:flex; gap:8px; padding:10px; border-top:1px solid #27313a; background:#11161a; position:relative; z-index:500; flex-wrap:wrap;}
  .toolbar button{background:#1b2832; color:#e9eef1; border:1px solid #2d3943; padding:10px 14px; border-radius:8px; cursor:pointer;}
  .toolbar button:hover{background:#21323d;}
  .panel{position:absolute; left:12px; top:12px; width:380px; max-width:92vw; max-height:76vh; background:#0f1418; border:1px solid #2d3943; border-radius:10px; box-shadow:0 10px 32px rgba(0,0,0,.45); overflow:auto; z-index:600; display:none;}
  .panel header{position:sticky; top:0; background:#0f1418; padding:10px 12px; border-bottom:1px solid #21303a; font-weight:700; display:flex; justify-content:space-between; align-items:center;}
  .panel .content{padding:12px;}
  .close-x{cursor:pointer; opacity:.8;}
  .grid{display:grid; gap:8px;}
  .grid.cols-2{grid-template-columns:1fr 1fr;}
  .stat{background:#101a20; border:1px solid #1e2a33; border-radius:8px; padding:8px 10px;}
  .small{font-size:12px; opacity:.8;}
  table{width:100%; border-collapse:collapse;}
  th,td{text-align:left; border-bottom:1px solid #1f2b33; padding:6px 4px; font-size:14px;}
  .hint{font-size:12px; opacity:.7; margin-top:4px;}
  select, input[type="number"], input[type="text"]{width:100%; padding:8px; border-radius:8px; border:1px solid #2c3943; background:#0f171d; color:#e9eef1;}
  .btn{display:inline-block; padding:8px 12px; border:1px solid #2d3943; background:#1b2832; color:#e9eef1; border-radius:8px; cursor:pointer;}
  .btn:hover{background:#223443;}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#19303b; border:1px solid #27414f; font-size:12px;}
  .legend{position:absolute; right:12px; top:12px; z-index:550; background:#0f1418; border:1px solid #2d3943; border-radius:10px; padding:8px 10px; display:flex; gap:10px; align-items:center;}
  .legend .dot{width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px;}
  .note{opacity:.8; font-size:12px;}
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
  .drawbar{position:absolute; left:12px; bottom:70px; z-index:650; background:#0f1418; border:1px solid #2d3943; border-radius:10px; padding:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .drawbar .lbl{font-size:12px; opacity:.8;}
  .file-input{display:none;}
  .badge{font-size:12px; opacity:.8; padding:4px 6px; border:1px solid #2d3943; border-radius:6px;}
</style>
</head>
<body>
<div id="app">
  <div id="map"></div>

  <div class="legend" id="legend"></div>

  <!-- Draw & Save controls -->
  <div class="drawbar">
    <span class="lbl">Manual Route for</span>
    <select id="ovrOrigin"></select>
    <span>→</span>
    <select id="ovrDest"></select>
    <button id="btnStartDraw" class="btn">Draw Polyline</button>
    <button id="btnSaveOverride" class="btn">Save Override</button>
    <button id="btnClearOverride" class="btn">Clear Override</button>
    <button id="btnExportOverrides" class="btn">Export</button>
    <label class="btn" for="fileImport">Import</label>
    <input id="fileImport" class="file-input" type="file" accept="application/json"/>
    <span class="badge">Store: local</span>
  </div>

  <!-- Company Panel -->
  <div class="panel" id="panelCompany">
    <header>
      <div>Company</div>
      <div class="close-x" data-close="#panelCompany">✕</div>
    </header>
    <div class="content">
      <div class="grid cols-2">
        <div class="stat"><div class="small">Bank</div><div id="statBank" style="font-size:18px;font-weight:700;">$0</div></div>
        <div class="stat"><div class="small">Daily Overhead</div><div id="statOverhead" style="font-size:18px;font-weight:700;">$0</div></div>
      </div>

      <h3>Drivers</h3>
      <table id="tblDrivers"><thead><tr><th>Name</th><th>Status</th><th>Location</th></tr></thead><tbody></tbody></table>

      <h3>Equipment</h3>
      <table id="tblEquip"><thead><tr><th>Type</th><th>Model</th><th>Owner</th></tr></thead><tbody></tbody></table>

      <h3>Properties</h3>
      <table id="tblProps"><thead><tr><th>Name</th><th>City</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- Market Panel -->
  <div class="panel" id="panelMarket">
    <header>
      <div>Market</div>
      <div class="close-x" data-close="#panelMarket">✕</div>
    </header>
    <div class="content">
      <h3>Buy Equipment</h3>
      <div class="grid cols-2">
        <div class="stat"><div class="small">Truck – Day Cab</div><div class="row"><div class="pill">$120,000</div><button class="btn" onclick="Game.buyEquipment('truck','Day Cab',120000)">Buy</button></div></div>
        <div class="stat"><div class="small">Truck – Sleeper</div><div class="row"><div class="pill">$165,000</div><button class="btn" onclick="Game.buyEquipment('truck','Sleeper',165000)">Buy</button></div></div>
        <div class="stat"><div class="small">Trailer – Dry Van</div><div class="row"><div class="pill">$42,000</div><button class="btn" onclick="Game.buyEquipment('trailer','Dry Van',42000)">Buy</button></div></div>
        <div class="stat"><div class="small">Trailer – Reefer</div><div class="row"><div class="pill">$78,000</div><button class="btn" onclick="Game.buyEquipment('trailer','Reefer',78000)">Buy</button></div></div>
      </div>

      <h3 style="margin-top:14px;">Buy Property</h3>
      <div class="grid cols-2">
        <div class="stat"><div class="small">Small Yard – Dallas</div><div class="row"><div class="pill">$350,000</div><button class="btn" onclick="Game.buyProperty('Dallas Yard','Dallas, TX',350000)">Buy</button></div></div>
        <div class="stat"><div class="small">Warehouse – Chicago</div><div class="row"><div class="pill">$1,200,000</div><button class="btn" onclick="Game.buyProperty('Chicago Warehouse','Chicago, IL',1200000)">Buy</button></div></div>
      </div>

      <div class="hint">Overhead increases per owned truck ($50/day) and per property ($200/day).</div>
    </div>
  </div>

  <!-- Dispatch Panel -->
  <div class="panel" id="panelDispatch">
    <header>
      <div>Dispatch</div>
      <div class="close-x" data-close="#panelDispatch">✕</div>
    </header>
    <div class="content">
      <div class="grid">
        <label>Driver<select id="selDriver"></select></label>
        <label>Origin<select id="selOrigin"></select></label>
        <label>Destination<select id="selDest"></select></label>
        <label>Average Speed (mph)<input type="number" id="inpSpeed" value="58" min="20" max="80"/></label>
        <label>Rate ($/mile)<input type="number" id="inpRate" value="2.50" step="0.05"/></label>
        <label>Fuel cost ($/mile)<input type="number" id="inpFuel" value="0.75" step="0.01"/></label>
        <label>Driver wage ($/mile)<input type="number" id="inpWage" value="0.60" step="0.01"/></label>
        <div><button class="btn" id="btnDispatch">Dispatch Load</button></div>
      </div>
      <div class="hint">Select from 48×3 city list. Manual overrides (drawn) take precedence; otherwise routes use the built-in interstate graph.</div>
      <h3 style="margin-top:12px;">Active Loads</h3>
      <table id="tblLoads"><thead><tr><th>Driver</th><th>From → To</th><th>ETA</th><th>Miles</th><th>Status</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div class="toolbar">
    <button onclick="UI.show('#panelCompany')">Company</button>
    <button onclick="UI.show('#panelMarket')">Market</button>
    <button onclick="UI.show('#panelDispatch')">Dispatch</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
/* ---------- Map ---------- */
const usBounds = L.latLngBounds([24.396308, -124.848974],[49.384358, -66.885444]);
const map = L.map('map', { minZoom: 3, maxZoom: 14, maxBounds: usBounds.pad(0.05), maxBoundsViscosity: 0.9, zoomControl: false })
  .setView([39.5, -98.35], 4);
L.control.zoom({ position: 'bottomright' }).addTo(map);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);

/* ---------- Manual override store (local-only) ---------- */
const OverrideStore = {
  key: 'manualOverridesV1',
  getAll(){ try{ return JSON.parse(localStorage.getItem(this.key) || '{}'); }catch(_){ return {}; } },
 saveAll(obj){ localStorage.setItem(this.key, JSON.stringify(obj)); },
  get(key){ const all=this.getAll(); return all[key] || null; },
  set(key, coords){
    const all=this.getAll();
    all[key]=coords;
    const [a,b]=key.split('|');
    const revKey=`${b}|${a}`;
    all[revKey]=coords.map(c=>[c[0],c[1]]).reverse();
    this.saveAll(all);
  },
  del(key){
    const all=this.getAll();
    if(key in all) delete all[key];
    const [a,b]=key.split('|');
    const revKey=`${b}|${a}`;
    if(revKey in all) delete all[revKey];
    this.saveAll(all);
  },
  export(){ return JSON.stringify(this.getAll(), null, 2); },
  import(json){ const obj=JSON.parse(json); if (typeof obj !== 'object' || Array.isArray(obj)) throw new Error('Invalid JSON'); this.saveAll(obj); }
};

/* ---------- Drawing (Leaflet.draw) ---------- */
const drawnItems = new L.FeatureGroup().addTo(map);
const drawControl = new L.Control.Draw({
  edit: { featureGroup: drawnItems, edit: true, remove: true },
  draw: { polyline: { shapeOptions: { color: '#00e5ff', weight: 4 } }, polygon:false, rectangle:false, circle:false, marker:false, circlemarker:false }
});
map.addControl(drawControl);
function clearNonOverrideDrawings(){ drawnItems.eachLayer(l => drawnItems.removeLayer(l)); }
function currentDrawnPolylineLatLngs(){ let latlngs=null; drawnItems.eachLayer(l => { if (l instanceof L.Polyline) latlngs = l.getLatLngs(); }); return latlngs; }
let overrideLayer=null;
function showOverridePolyline(coords){
  if (overrideLayer) { map.removeLayer(overrideLayer); overrideLayer=null; }
  if (!coords || !coords.length) return;
  overrideLayer = L.polyline(coords, {color:'#ffaa00', weight:4, opacity:0.8, dashArray:'6,6'}).addTo(map);
  try { map.fitBounds(overrideLayer.getBounds().pad(0.15)); } catch(_){}
}
map.on(L.Draw.Event.CREATED, e => { clearNonOverrideDrawings(); drawnItems.addLayer(e.layer); });

/* ---------- Interstate graph (coarse A*) ---------- */
const Graph = (() => {
  const NODES = [
    ['NYC','New York, NY',40.7128,-74.0060],['BOS','Boston, MA',42.3601,-71.0589],
    ['PHL','Philadelphia, PA',39.9526,-75.1652],['PIT','Pittsburgh, PA',40.4406,-79.9959],
    ['CLE','Cleveland, OH',41.4993,-81.6944],['CHI','Chicago, IL',41.8781,-87.6298],
    ['IND','Indianapolis, IN',39.7684,-86.1581],['STL','St. Louis, MO',38.6270,-90.1994],
    ['KC','Kansas City, MO',39.0997,-94.5786],['OMA','Omaha, NE',41.2565,-95.9345],
    ['DEN','Denver, CO',39.7392,-104.9903],['SLC','Salt Lake City, UT',40.7608,-111.8910],
    ['PHX','Phoenix, AZ',33.4484,-112.0740],['LA','Los Angeles, CA',34.0522,-118.2437],
    ['SEA','Seattle, WA',47.6062,-122.3321],['POR','Portland, OR',45.5152,-122.6784],
    ['ATL','Atlanta, GA',33.7490,-84.3880],['CHA','Chattanooga, TN',35.0456,-85.3097],
    ['JAX','Jacksonville, FL',30.3322,-81.6557],['MIA','Miami, FL',25.7617,-80.1918],
    ['DAL','Dallas, TX',32.7767,-96.7970],['HOU','Houston, TX',29.7604,-95.3698]
  ];
  const EDGES = [
    ['NYC','PHL','I-95'],['PHL','PIT','I-76'],['PIT','CLE','I-80'],['CLE','CHI','I-90'],
    ['CHI','IND','I-65'],['IND','STL','I-70'],['STL','KC','I-70'],['KC','OMA','I-29'],['OMA','DEN','I-80'],
    ['DEN','SLC','I-80'],['SLC','PHX','I-15/I-17'],['PHX','LA','I-10'],
    ['SEA','POR','I-5'],['POR','SLC','I-84'],
    ['ATL','CHA','I-75'],['CHA','IND','I-24/I-65'],['ATL','JAX','I-75/I-10'],['JAX','MIA','I-95'],
    ['DAL','HOU','I-45'],['DAL','KC','I-35'],['DAL','PHX','I-10/I-20/I-10']
  ];
  const nodeById = new Map(NODES.map(n => [n[0], {id:n[0], name:n[1], lat:n[2], lng:n[3]}]));
  const neighbors = new Map();
  for (const [a,b,ref] of EDGES) {
    const A=nodeById.get(a), B=nodeById.get(b);
    const d=haversineMiles(A,B);
    if(!neighbors.has(a)) neighbors.set(a,[]);
    if(!neighbors.has(b)) neighbors.set(b,[]);
    neighbors.get(a).push({to:b,dist:d,ref});
    neighbors.get(b).push({to:a,dist:d,ref});
  }
  function nearestNode(lat,lng){ let best=null,b=Infinity; for(const n of nodeById.values()){ const d=haversineMiles({lat,lng},{lat:n.lat,lng:n.lng}); if(d<b){b=d; best=n;} } return best; }
  function aStar(sid,gid){
    const open=new Set([sid]), came=new Map(), g=new Map([[sid,0]]), f=new Map([[sid,haversineMiles(nodeById.get(sid),nodeById.get(gid))]]);
    function lowest(){ let id=null,b=Infinity; for(const x of open){ const v=f.get(x)??Infinity; if(v<b){b=v; id=x;} } return id; }
    while(open.size){
      const cur=lowest(); if(cur===gid) break; open.delete(cur);
      for(const e of (neighbors.get(cur)||[])){
        const t=(g.get(cur)??Infinity)+e.dist;
        if(t < (g.get(e.to)??Infinity)){ came.set(e.to,{prev:cur,edge:e}); g.set(e.to,t); f.set(e.to,t+haversineMiles(nodeById.get(e.to),nodeById.get(gid))); open.add(e.to); }
      }
    }
    if(!came.has(gid) && sid!==gid) return null;
    const nodes=[gid]; let c=gid; while(c!==sid){ const s=came.get(c); if(!s) break; c=s.prev; nodes.push(c); } nodes.reverse();
    const core=[]; core.push({lat:nodeById.get(nodes[0]).lat,lng:nodeById.get(nodes[0]).lng});
    for(let i=1;i<nodes.length;i++){ const n=nodeById.get(nodes[i]); core.push({lat:n.lat,lng:n.lng}); }
    let dist=0; for(let i=1;i<core.length;i++) dist+=haversineMiles(core[i-1],core[i]);
    return {core, dist};
  }
  function route(from,to){
    const s=nearestNode(from.lat,from.lng), g=nearestNode(to.lat,to.lng);
    const r=aStar(s.id,g.id);
    if(!r) return { path:[from,to], distanceMiles:haversineMiles(from,to) };
    const poly=[from, ...r.core, to]; let dist=0; for(let i=1;i<poly.length;i++) dist+=haversineMiles(poly[i-1],poly[i]);
    return { path:poly, distanceMiles:dist };
  }
  return { route };
})();

/* ---------- Cities: top 3 per contiguous state, grouped ---------- */
const CityGroups = [
  {state:'Alabama', items:[
    {name:'Birmingham, AL',lat:33.5186,lng:-86.8104},
    {name:'Montgomery, AL',lat:32.3668,lng:-86.3000},
    {name:'Huntsville, AL',lat:34.7304,lng:-86.5861}
  ]},
  {state:'Arizona', items:[
    {name:'Phoenix, AZ',lat:33.4484,lng:-112.0740},
    {name:'Tucson, AZ',lat:32.2226,lng:-110.9747},
    {name:'Mesa, AZ',lat:33.4152,lng:-111.8315}
  ]},
  {state:'Arkansas', items:[
    {name:'Little Rock, AR',lat:34.7465,lng:-92.2896},
    {name:'Fort Smith, AR',lat:35.3859,lng:-94.3985},
    {name:'Fayetteville, AR',lat:36.0626,lng:-94.1574}
  ]},
  {state:'California', items:[
    {name:'Los Angeles, CA',lat:34.0522,lng:-118.2437},
    {name:'San Diego, CA',lat:32.7157,lng:-117.1611},
    {name:'San Jose, CA',lat:37.3382,lng:-121.8863}
  ]},
  {state:'Colorado', items:[
    {name:'Denver, CO',lat:39.7392,lng:-104.9903},
    {name:'Colorado Springs, CO',lat:38.8339,lng:-104.8214},
    {name:'Aurora, CO',lat:39.7294,lng:-104.8319}
  ]},
  {state:'Connecticut', items:[
    {name:'Bridgeport, CT',lat:41.1792,lng:-73.1894},
    {name:'New Haven, CT',lat:41.3083,lng:-72.9279},
    {name:'Stamford, CT',lat:41.0534,lng:-73.5387}
  ]},
  {state:'Delaware', items:[
    {name:'Wilmington, DE',lat:39.7391,lng:-75.5398},
    {name:'Dover, DE',lat:39.1582,lng:-75.5244},
    {name:'Newark, DE',lat:39.6837,lng:-75.7497}
  ]},
  {state:'Florida', items:[
    {name:'Jacksonville, FL',lat:30.3322,lng:-81.6557},
    {name:'Miami, FL',lat:25.7617,lng:-80.1918},
    {name:'Tampa, FL',lat:27.9506,lng:-82.4572}
  ]},
  {state:'Georgia', items:[
    {name:'Atlanta, GA',lat:33.7490,lng:-84.3880},
    {name:'Columbus, GA',lat:32.46098,lng:-84.9877},
    {name:'Augusta, GA',lat:33.4735,lng:-82.0105}
  ]},
  {state:'Idaho', items:[
    {name:'Boise, ID',lat:43.6150,lng:-116.2023},
    {name:'Nampa, ID',lat:43.5407,lng:-116.5635},
    {name:'Meridian, ID',lat:43.6121,lng:-116.3915}
  ]},
  {state:'Illinois', items:[
    {name:'Chicago, IL',lat:41.8781,lng:-87.6298},
    {name:'Aurora, IL',lat:41.7606,lng:-88.3201},
    {name:'Joliet, IL',lat:41.5250,lng:-88.0817}
  ]},
  {state:'Indiana', items:[
    {name:'Indianapolis, IN',lat:39.7684,lng:-86.1581},
    {name:'Fort Wayne, IN',lat:41.0793,lng:-85.1394},
    {name:'Evansville, IN',lat:37.9716,lng:-87.5711}
  ]},
  {state:'Iowa', items:[
    {name:'Des Moines, IA',lat:41.5868,lng:-93.6250},
    {name:'Cedar Rapids, IA',lat:41.9779,lng:-91.6656},
    {name:'Davenport, IA',lat:41.5236,lng:-90.5776}
  ]},
  {state:'Kansas', items:[
    {name:'Wichita, KS',lat:37.6872,lng:-97.3301},
    {name:'Overland Park, KS',lat:38.9822,lng:-94.6708},
    {name:'Kansas City, KS',lat:39.1142,lng:-94.6275}
  ]},
  {state:'Kentucky', items:[
    {name:'Louisville, KY',lat:38.2527,lng:-85.7585},
    {name:'Lexington, KY',lat:38.0406,lng:-84.5037},
    {name:'Bowling Green, KY',lat:36.9685,lng:-86.4808}
  ]},
  {state:'Louisiana', items:[
    {name:'New Orleans, LA',lat:29.9511,lng:-90.0715},
    {name:'Baton Rouge, LA',lat:30.4515,lng:-91.1871},
    {name:'Shreveport, LA',lat:32.5252,lng:-93.7502}
  ]},
  {state:'Maine', items:[
    {name:'Portland, ME',lat:43.6591,lng:-70.2568},
    {name:'Lewiston, ME',lat:44.1004,lng:-70.2148},
    {name:'Bangor, ME',lat:44.8012,lng:-68.7778}
  ]},
  {state:'Maryland', items:[
    {name:'Baltimore, MD',lat:39.2904,lng:-76.6122},
    {name:'Frederick, MD',lat:39.4143,lng:-77.4105},
    {name:'Rockville, MD',lat:39.0834,lng:-77.1528}
  ]},
  {state:'Massachusetts', items:[
    {name:'Boston, MA',lat:42.3601,lng:-71.0589},
    {name:'Worcester, MA',lat:42.2626,lng:-71.8023},
    {name:'Springfield, MA',lat:42.1015,lng:-72.5898}
  ]},
  {state:'Michigan', items:[
    {name:'Detroit, MI',lat:42.3314,lng:-83.0458},
    {name:'Grand Rapids, MI',lat:42.9634,lng:-85.6681},
    {name:'Warren, MI',lat:42.5145,lng:-83.0147}
  ]},
  {state:'Minnesota', items:[
    {name:'Minneapolis, MN',lat:44.9778,lng:-93.2650},
    {name:'Saint Paul, MN',lat:44.9537,lng:-93.0900},
    {name:'Rochester, MN',lat:44.0121,lng:-92.4802}
  ]},
  {state:'Mississippi', items:[
    {name:'Jackson, MS',lat:32.2988,lng:-90.1848},
    {name:'Gulfport, MS',lat:30.3674,lng:-89.0928},
    {name:'Southaven, MS',lat:34.9890,lng:-90.0126}
  ]},
  {state:'Missouri', items:[
    {name:'Kansas City, MO',lat:39.0997,lng:-94.5786},
    {name:'St. Louis, MO',lat:38.6270,lng:-90.1994},
    {name:'Springfield, MO',lat:37.2089,lng:-93.2923}
  ]},
  {state:'Montana', items:[
    {name:'Billings, MT',lat:45.7833,lng:-108.5007},
    {name:'Missoula, MT',lat:46.8721,lng:-113.9940},
    {name:'Great Falls, MT',lat:47.5053,lng:-111.3008}
  ]},
  {state:'Nebraska', items:[
    {name:'Omaha, NE',lat:41.2565,lng:-95.9345},
    {name:'Lincoln, NE',lat:40.8136,lng:-96.7026},
    {name:'Bellevue, NE',lat:41.1544,lng:-95.9146}
  ]},
  {state:'Nevada', items:[
    {name:'Las Vegas, NV',lat:36.1699,lng:-115.1398},
    {name:'Henderson, NV',lat:36.0395,lng:-114.9817},
    {name:'Reno, NV',lat:39.5296,lng:-119.8138}
  ]},
  {state:'New Hampshire', items:[
    {name:'Manchester, NH',lat:42.9956,lng:-71.4548},
    {name:'Nashua, NH',lat:42.7654,lng:-71.4676},
    {name:'Concord, NH',lat:43.2081,lng:-71.5376}
  ]},
  {state:'New Jersey', items:[
    {name:'Newark, NJ',lat:40.7357,lng:-74.1724},
    {name:'Jersey City, NJ',lat:40.7178,lng:-74.0431},
    {name:'Paterson, NJ',lat:40.9168,lng:-74.1718}
  ]},
  {state:'New Mexico', items:[
    {name:'Albuquerque, NM',lat:35.0844,lng:-106.6504},
    {name:'Las Cruces, NM',lat:32.3199,lng:-106.7637},
    {name:'Rio Rancho, NM',lat:35.2328,lng:-106.6630}
  ]},
  {state:'New York', items:[
    {name:'New York, NY',lat:40.7128,lng:-74.0060},
    {name:'Buffalo, NY',lat:42.8864,lng:-78.8784},
    {name:'Rochester, NY',lat:43.1566,lng:-77.6088}
  ]},
  {state:'North Carolina', items:[
    {name:'Charlotte, NC',lat:35.2271,lng:-80.8431},
    {name:'Raleigh, NC',lat:35.7796,lng:-78.6382},
    {name:'Greensboro, NC',lat:36.0726,lng:-79.7920}
  ]},
  {state:'North Dakota', items:[
    {name:'Fargo, ND',lat:46.8772,lng:-96.7898},
    {name:'Bismarck, ND',lat:46.8083,lng:-100.7837},
    {name:'Grand Forks, ND',lat:47.9253,lng:-97.0329}
  ]},
  {state:'Ohio', items:[
    {name:'Columbus, OH',lat:39.9612,lng:-82.9988},
    {name:'Cleveland, OH',lat:41.4993,lng:-81.6944},
    {name:'Cincinnati, OH',lat:39.1031,lng:-84.5120}
  ]},
  {state:'Oklahoma', items:[
    {name:'Oklahoma City, OK',lat:35.4676,lng:-97.5164},
    {name:'Tulsa, OK',lat:36.1540,lng:-95.9928},
    {name:'Norman, OK',lat:35.2226,lng:-97.4395}
  ]},
  {state:'Oregon', items:[
    {name:'Portland, OR',lat:45.5152,lng:-122.6784},
    {name:'Salem, OR',lat:44.9429,lng:-123.0351},
    {name:'Eugene, OR',lat:44.0521,lng:-123.0868}
  ]},
  {state:'Pennsylvania', items:[
    {name:'Philadelphia, PA',lat:39.9526,lng:-75.1652},
    {name:'Pittsburgh, PA',lat:40.4406,lng:-79.9959},
    {name:'Allentown, PA',lat:40.6023,lng:-75.4714}
  ]},
  {state:'Rhode Island', items:[
    {name:'Providence, RI',lat:41.8240,lng:-71.4128},
    {name:'Warwick, RI',lat:41.7001,lng:-71.4162},
    {name:'Cranston, RI',lat:41.7798,lng:-71.4373}
  ]},
  {state:'South Carolina', items:[
    {name:'Columbia, SC',lat:34.0007,lng:-81.0348},
    {name:'Charleston, SC',lat:32.7765,lng:-79.9311},
    {name:'North Charleston, SC',lat:32.8546,lng:-79.9748}
  ]},
  {state:'South Dakota', items:[
    {name:'Sioux Falls, SD',lat:43.5446,lng:-96.7311},
    {name:'Rapid City, SD',lat:44.0805,lng:-103.2310},
    {name:'Aberdeen, SD',lat:45.4647,lng:-98.4865}
  ]},
  {state:'Tennessee', items:[
    {name:'Memphis, TN',lat:35.1495,lng:-90.0490},
    {name:'Nashville, TN',lat:36.1627,lng:-86.7816},
    {name:'Knoxville, TN',lat:35.9606,lng:-83.9207}
  ]},
  {state:'Texas', items:[
    {name:'Houston, TX',lat:29.7604,lng:-95.3698},
    {name:'San Antonio, TX',lat:29.4241,lng:-98.4936},
    {name:'Dallas, TX',lat:32.7767,lng:-96.7970}
  ]},
  {state:'Utah', items:[
    {name:'Salt Lake City, UT',lat:40.7608,lng:-111.8910},
    {name:'West Valley City, UT',lat:40.6916,lng:-112.0010},
    {name:'Provo, UT',lat:40.2338,lng:-111.6585}
  ]},
  {state:'Vermont', items:[
    {name:'Burlington, VT',lat:44.4759,lng:-73.2121},
    {name:'South Burlington, VT',lat:44.4670,lng:-73.1710},
    {name:'Rutland, VT',lat:43.6106,lng:-72.9726}
  ]},
  {state:'Virginia', items:[
    {name:'Virginia Beach, VA',lat:36.8529,lng:-75.9780},
    {name:'Norfolk, VA',lat:36.8508,lng:-76.2859},
    {name:'Chesapeake, VA',lat:36.7682,lng:-76.2875}
  ]},
  {state:'Washington', items:[
    {name:'Seattle, WA',lat:47.6062,lng:-122.3321},
    {name:'Spokane, WA',lat:47.6588,lng:-117.4260},
    {name:'Tacoma, WA',lat:47.2529,lng:-122.4443}
  ]},
  {state:'West Virginia', items:[
    {name:'Charleston, WV',lat:38.3498,lng:-81.6326},
    {name:'Huntington, WV',lat:38.4192,lng:-82.4452},
    {name:'Morgantown, WV',lat:39.6295,lng:-79.9559}
  ]},
  {state:'Wisconsin', items:[
    {name:'Milwaukee, WI',lat:43.0389,lng:-87.9065},
    {name:'Madison, WI',lat:43.0731,lng:-89.4012},
    {name:'Green Bay, WI',lat:44.5133,lng:-88.0133}
  ]},
  {state:'Wyoming', items:[
    {name:'Cheyenne, WY',lat:41.1400,lng:-104.8202},
    {name:'Casper, WY',lat:42.8501,lng:-106.3252},
    {name:'Laramie, WY',lat:41.3114,lng:-105.5911}
  ]}
];
const Cities = CityGroups.flatMap(g => g.items);

/* ---------- Colors ---------- */
const Colors = ['#ff595e','#ffca3a','#8ac926','#1982c4','#6a4c93','#f72585','#b5179e','#7209b7','#560bad','#480ca8','#3f37c9','#4895ef','#4cc9f0','#80ed99','#57cc99'];

/* ---------- Router wrapper: overrides first, else A* ---------- */
const Router = {
  async route(orig, dest) {
    const key = `${orig.name}|${dest.name}`;
    const ovr = OverrideStore.get(key);
    if (ovr && Array.isArray(ovr) && ovr.length >= 2) {
      const path = ovr.map(([lat,lng]) => ({lat, lng}));
      let dist=0; for(let i=1;i<path.length;i++) dist += haversineMiles(path[i-1], path[i]);
      return { path, distanceMiles: dist, durationMs: 0 };
    }
    const r = Graph.route({lat:orig.lat,lng:orig.lng},{lat:dest.lat,lng:dest.lng});
    return { path: r.path, distanceMiles: r.distanceMiles, durationMs: 0 };
  }
};

/* ---------- Game ---------- */
const Game = {
  bank: 250000,
  overheadPerTruck: 50,
  overheadPerProperty: 200,
  drivers: [],
  equipment: [],
  properties: [],
  loads: [],
  tickMs: 1000,
  init() {
    // Seed a few drivers at big hubs
    this.addDriver('Alice', cityByName('Chicago, IL'));
    this.addDriver('Ben',   cityByName('Dallas, TX'));
    this.addDriver('Cara',  cityByName('Atlanta, GA'));
    UI.refreshAll();
    this.loop = setInterval(()=>this.update(), this.tickMs);
    this.overheadLoop = setInterval(()=>this.applyOverhead(), 60000);
    UI.initOverridesUI();
  },
  addDriver(name, city) {
    const color = Colors[this.drivers.length % Colors.length];
    const driver = new Driver(name, city.lat, city.lng, color);
    this.drivers.push(driver);
    driver.render();
    UI.updateLegend();
  },
  buyEquipment(type, model, cost) {
    if (this.bank < cost) { alert('Insufficient funds.'); return; }
    this.bank -= cost;
    this.equipment.push({type, model, owner:'You'});
    UI.refreshCompany();
  },
  buyProperty(name, city, cost) {
    if (this.bank < cost) { alert('Insufficient funds.'); return; }
    this.bank -= cost;
    this.properties.push({name, city});
    UI.refreshCompany();
  },
  async dispatch(driverId, origin, dest, mph, ratePerMile, fuelPerMile, wagePerMile) {
    const d = this.drivers.find(x => x.id === driverId);
    if (!d) return;
    if (d.status !== 'Idle') { alert('Driver is busy.'); return; }

    const r = await Router.route(origin, dest);
    const miles = Math.round(r.distanceMiles);
    const hours = miles / Math.max(20, Math.min(80, mph));
    const etaMs = hours * 3600 * 1000;

    const payout = miles * ratePerMile;
    const cost = miles * (fuelPerMile + wagePerMile);
    const profit = Math.round(payout - cost);

    const load = {
      id: crypto.randomUUID(),
      driverId: d.id, driverName: d.name, color: d.color,
      originName: origin.name, destName: dest.name,
      start: r.path[0], end: r.path[r.path.length-1],
      miles, startTime: performance.now(),
      etaMs, status: 'En Route', profit
    };
    this.loads.push(load);

    d.startTripPolyline(r.path, load.id);
    UI.refreshDispatch();
  },
  completeLoad(load) {
    this.bank += load.profit;
    load.status = 'Delivered';
    UI.refreshDispatch();
    UI.refreshCompany();
  },
  update() {
    const now = performance.now();
    for (const d of this.drivers) {
      if (d.status === 'On Trip') {
        const ld = this.loads.find(l => l.id === d.currentLoadId);
        if (!ld) continue;
        const t = (now - ld.startTime) / ld.etaMs;
        if (t >= 1) { d.finishTrip(ld.end); this.completeLoad(ld); }
        else {
          if (d.path && d.cumMiles) {
            const totalMiles = d.cumMiles[d.cumMiles.length - 1] || 0.00001;
            const targetMiles = totalMiles * t;
            const p = interpolateAlong(d.path, d.cumMiles, targetMiles);
            d.setPosition(p.lat, p.lng);
          } else { // straight fallback
            const p = lerpPoint(ld.start, ld.end, t);
            d.setPosition(p.lat, p.lng);
          }
        }
      }
    }
    UI.refreshTablesLive();
  },
  applyOverhead() {
    const trucks = this.equipment.filter(e => e.type === 'truck').length;
    const props = this.properties.length;
    const burn = trucks * this.overheadPerTruck + props * this.overheadPerProperty;
    if (burn > 0) { this.bank -= burn; UI.refreshCompany(); }
  }
};

/* ---------- Driver ---------- */
let _driverIdCounter = 1;
class Driver {
  constructor(name, lat, lng, color) {
    this.id = _driverIdCounter++; this.name = name; this.color = color;
    this.lat = lat; this.lng = lng; this.status = 'Idle'; this.currentLoadId = null;
    this.marker = L.circleMarker([lat, lng], { radius:7, color:color, weight:2, fillColor:color, fillOpacity:0.7 });
    this.routeLine = null;
    this.path = null; this.cumMiles = null;
  }
  render(){ this.marker.addTo(map); }
  setPosition(lat,lng){ this.lat=lat; this.lng=lng; this.marker.setLatLng([lat,lng]); }
  startTripPolyline(path, loadId){
    this.currentLoadId = loadId; this.status='On Trip';
    this.path = path.slice();
    this.cumMiles = cumulativeMiles(this.path);
    if (this.routeLine) map.removeLayer(this.routeLine);
    this.routeLine = L.polyline(this.path.map(p => [p.lat, p.lng]), { color:this.color, weight:3, opacity:0.9 }).addTo(map);
  }
  finishTrip(end){
    this.setPosition(end.lat,end.lng); this.status='Idle'; this.currentLoadId=null;
    this.path = null; this.cumMiles = null;
    if (this.routeLine){ this.routeLine.setStyle({opacity:0.3, dashArray:'2,8'}); setTimeout(()=>{ if (this.routeLine) map.removeLayer(this.routeLine); },4000); this.routeLine=null; }
  }
}

/* ---------- Utilities ---------- */
function haversineMiles(a,b){ const R=3958.7613, toRad=d=>d*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const lat1=toRad(a.lat), lat2=toRad(b.lat);
  const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}
function lerp(a,b,t){ return a+(b-a)*t; }
function lerpPoint(p1,p2,t){ return {lat:lerp(p1.lat,p2.lat,t), lng:lerp(p1.lng,p2.lng,t)}; }
function cumulativeMiles(latlngs){ const cum=[0]; for(let i=1;i<latlngs.length;i++){ cum[i]=cum[i-1]+haversineMiles(latlngs[i-1],latlngs[i]); } return cum; }
function interpolateAlong(latlngs,cumMiles,targetMiles){
  let i=1; while(i<cumMiles.length && cumMiles[i]<targetMiles) i++;
  if(i>=latlngs.length) return latlngs[latlngs.length-1];
  const m0=cumMiles[i-1], m1=cumMiles[i]; const t=m1===m0?0:(targetMiles-m0)/(m1-m0);
  return lerpPoint(latlngs[i-1], latlngs[i], Math.max(0,Math.min(1,t)));
}
function cityByName(name){ const c=Cities.find(x=>x.name===name); if(!c) throw new Error('City not found: '+name); return c; }

/* ---------- UI ---------- */
const UI = {
  show(sel){ document.querySelectorAll('.panel').forEach(p=>p.style.display='none'); const el=document.querySelector(sel); if (el) el.style.display='block'; },
  init(){
    document.querySelectorAll('.close-x').forEach(x=>x.addEventListener('click', e=>{ const t=e.currentTarget.getAttribute('data-close'); if (t) document.querySelector(t).style.display='none'; }));
    const selDriver=document.getElementById('selDriver'), selOrigin=document.getElementById('selOrigin'), selDest=document.getElementById('selDest');
    // Fill grouped selects
    fillCitySelectGrouped(selOrigin); fillCitySelectGrouped(selDest);
    // Also for manual override draw bar
    fillCitySelectGrouped(document.getElementById('ovrOrigin'));
    fillCitySelectGrouped(document.getElementById('ovrDest'));
    // Defaults
    selOrigin.value='Chicago, IL'; selDest.value='New York, NY';
    document.getElementById('ovrOrigin').value='Chicago, IL'; document.getElementById('ovrDest').value='New York, NY';
    // Dispatch click
    document.getElementById('btnDispatch').addEventListener('click', async ()=>{
      const dId=parseInt(selDriver.value,10);
      const o=cityByName(selOrigin.value), de=cityByName(selDest.value);
      const mph=Number(document.getElementById('inpSpeed').value||58);
      const rate=Number(document.getElementById('inpRate').value||2.5);
      const fuel=Number(document.getElementById('inpFuel').value||0.75);
      const wage=Number(document.getElementById('inpWage').value||0.6);
      if (o.name===de.name){ alert('Origin and destination must differ.'); return; }
      await Game.dispatch(dId,o,de,mph,rate,fuel,wage);
    });
    this.refreshAll();
  },
  initOverridesUI(){
    const selO=document.getElementById('ovrOrigin'), selD=document.getElementById('ovrDest');
    const refreshGhost=()=>{ const key=`${selO.value}|${selD.value}`; showOverridePolyline(OverrideStore.get(key)); };
    selO.addEventListener('change', refreshGhost);
    selD.addEventListener('change', refreshGhost);
    document.getElementById('btnStartDraw').addEventListener('click', ()=>{
      clearNonOverrideDrawings();
      new L.Draw.Polyline(map, drawControl.options.draw.polyline).enable();
    });
document.getElementById('btnSaveOverride').addEventListener('click', ()=>{
      const latlngs=currentDrawnPolylineLatLngs();
      if(!latlngs || latlngs.length<2){ alert('Draw a polyline first.'); return; }
      const coords = latlngs.map(ll => [ll.lat, ll.lng]);
      const key=`${selO.value}|${selD.value}`;
      const revKey=`${selD.value}|${selO.value}`;
      OverrideStore.set(key, coords);
      showOverridePolyline(coords);
      clearNonOverrideDrawings();
      alert('Override saved for ' + key + ' and ' + revKey);
    });
    document.getElementById('btnClearOverride').addEventListener('click', ()=>{
      const key=`${selO.value}|${selD.value}`;
      const revKey=`${selD.value}|${selO.value}`;
      OverrideStore.del(key);
      showOverridePolyline(null);
      alert('Override cleared for ' + key + ' and ' + revKey);
    });
    document.getElementById('btnExportOverrides').addEventListener('click', ()=>{
      const data = OverrideStore.export();
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='manual_overrides.json'; a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById('fileImport').addEventListener('change', (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader(); reader.onload = () => {
        try { OverrideStore.import(reader.result); alert('Overrides imported.'); refreshGhost(); }
        catch(err){ alert('Import failed: ' + err.message); }
      }; reader.readAsText(file); e.target.value='';
    });
    refreshGhost();
  },
  refreshAll(){ this.refreshCompany(); this.refreshDispatch(); this.updateLegend(); this.refreshDrivers(); },
  refreshCompany(){
    document.getElementById('statBank').textContent='$'+Game.bank.toLocaleString();
    const trucks=Game.equipment.filter(e=>e.type==='truck').length, props=Game.properties.length;
    document.getElementById('statOverhead').textContent='$'+(trucks*Game.overheadPerTruck + props*Game.overheadPerProperty).toLocaleString()+' / day';
    const tbodyD=document.querySelector('#tblDrivers tbody'); tbodyD.innerHTML='';
    for (const d of Game.drivers){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><span class="dot" style="background:${d.color}; width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px;"></span>${d.name}</td>
                    <td>${d.status}</td><td>${d.lat.toFixed(2)}, ${d.lng.toFixed(2)}</td>`;
      tbodyD.appendChild(tr);
    }
    const tbodyE=document.querySelector('#tblEquip tbody'); tbodyE.innerHTML='';
    for (const e of Game.equipment){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${e.type}</td><td>${e.model}</td><td>${e.owner}</td>`; tbodyE.appendChild(tr); }
    const tbodyP=document.querySelector('#tblProps tbody'); tbodyP.innerHTML='';
    for (const p of Game.properties){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.name}</td><td>${p.city}</td>`; tbodyP.appendChild(tr); }
  },
  refreshDrivers(){
    const selDriver=document.getElementById('selDriver'); selDriver.innerHTML='';
    for (const d of Game.drivers){ const o=document.createElement('option'); o.value=d.id; o.textContent=`${d.name} (${d.status})`; selDriver.appendChild(o); }
  },
  refreshDispatch(){
    const tbody=document.querySelector('#tblLoads tbody'); tbody.innerHTML='';
    for (const l of Game.loads.slice().reverse()){
      const etaLeft=Math.max(0, l.etaMs - (performance.now()-l.startTime));
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><span class="dot" style="background:${l.color}; width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px;"></span>${l.driverName}</td>
                    <td>${l.originName} → ${l.destName}</td>
                    <td>${l.status==='En Route' ? fmtETA(etaLeft) : '—'}</td>
                    <td>${l.miles}</td>
                    <td>${l.status}${l.status==='Delivered' ? ` (+$${l.profit.toLocaleString()})` : ''}</td>`;
      tbody.appendChild(tr);
    }
    document.getElementById('statBank').textContent='$'+Game.bank.toLocaleString();
  },
  refreshTablesLive(){ this.refreshCompany(); this.refreshDispatch(); },
  updateLegend(){
    const el=document.getElementById('legend'); el.innerHTML='<div class="note">Drivers</div>';
    for (const d of Game.drivers){ const span=document.createElement('span'); span.innerHTML=`<span class="dot" style="background:${d.color}"></span>${d.name}`; el.appendChild(span); }
  }
};
function fillCitySelectGrouped(sel){
  sel.innerHTML='';
  for(const g of CityGroups){
    const og=document.createElement('optgroup'); og.label=g.state; // bold label by UA
    for(const c of g.items){
      const o=document.createElement('option'); o.value=c.name; o.textContent=c.name;
      og.appendChild(o);
    }
    sel.appendChild(og);
  }
}

/* ---------- Boot ---------- */
UI.init();
Game.init();
</script>
</body>
</html>

